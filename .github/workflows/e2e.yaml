name: End-to-End Tests
on:
  pull_request: {}
  workflow_dispatch: {}
  schedule:
    - cron: "4 3 * * 2" # Tuesdays 03:04 am.
  push:
    branches: ["main"]
env:
  architecture: amd64
  base_url: https://cdimages.ubuntu.com/ubuntu-wsl/daily-live/current
  images_dir: images
  instance: Ubuntu-${{ github.run_id }}
  instance_working_dir: ~/wsl-setup-${{ github.run_id }}
  REGISTRY_PATH: "HKCU:\\Software\\Canonical\\Ubuntu"
  REGISTRY_KEY: "UbuntuInsightsConsent"

jobs:
  build-deb:
    name: Build wsl-setup debian package
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
      - name: Build deb
        uses: canonical/desktop-engineering/gh-actions/common/build-debian@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          docker-image: ubuntu:devel

  cache-img:
    name: Cache the daily-live image
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
      - name: Get WSL Image
        uses: ./.github/actions/get-wsl-image
        with:
          output_path: images.wsl

  e2e-test:
    needs: [build-deb, cache-img]
    name: "E2E: ${{ matrix.name }}"
    runs-on: windows-2025
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Consent Default"
            consent: "default"
            username: "testuser"
            password: "password"
            registry-flag: "skip"
            config-state: "skip"
          - name: "Consent Yes"
            consent: "yes"
            username: "testuser"
            password: "password"
            registry-flag: "skip"
            config-state: "skip"
          - name: "Consent No"
            consent: "no"
            username: "testuser"
            password: "password"
            registry-flag: "skip"
            config-state: "skip"
          - name: "Skip (Registry)"
            consent: "skip"
            username: "testuser"
            password: "password"
            registry-flag: "1"
            config-state: "skip"
          - name: "Skip (Config)"
            consent: "skip"
            username: "testuser"
            password: "password"
            registry-flag: "skip"
            config-state: "true"

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Download artifacts
        uses: actions/download-artifact@v5
        with:
          path: ci-artifacts

      - name: Get WSL Image
        uses: ./.github/actions/get-wsl-image
        with:
          output_path: images.wsl

      - name: Set Registry Key
        if: matrix.registry-flag != 'skip'
        shell: powershell
        run: |
          New-Item -Path "${{ env.REGISTRY_PATH }}" -Force
          New-ItemProperty -Path "${{ env.REGISTRY_PATH }}" -Name "${{ env.REGISTRY_KEY }}" -Value "${{ matrix.registry-flag }}" -PropertyType DWord -Force

      - name: Install WSL Instance
        shell: powershell
        run: |
          wsl --install --no-launch --from-file "images.wsl" --name "${{ env.instance }}"

      - name: Install wsl-setup and test prerequisites
        shell: powershell
        run: |
          # Install the deb package
          wsl -d "${{ env.instance }}" -u root -- dpkg -i "./ci-artifacts/wsl-setup_*/wsl-setup_*.deb"
          # Install expect
          wsl -d "${{ env.instance }}" -u root -- apt-get update
          wsl -d "${{ env.instance }}" -u root -- apt-get install -y expect

      - name: Configure Consent File
        if: matrix.config-state != 'skip'
        shell: powershell
        run: |
          $configContent = "consent_state = ${{ matrix.config-state }}"
          wsl -d "${{ env.instance }}" -u root -- bash -c "mkdir -p /etc/skel/.config/ubuntu-insights"
          wsl -d "${{ env.instance }}" -u root -- bash -c "echo '$configContent' > /etc/skel/.config/ubuntu-insights/consent.toml"

      - name: Reset WSL instance state
        shell: powershell
        run: |
          wsl -d "${{ env.instance }}" -u root -- cloud-init status --wait
          wsl -d "${{ env.instance }}" -u root -- bash -ec "rm /etc/cloud/cloud-init.disabled || true"
          wsl -d "${{ env.instance }}" -u root -- cloud-init clean --logs
          wsl --shutdown

      - name: Run Expect Test
        shell: powershell
        timeout-minutes: 10
        run: |
          # Copy expect script to instance
          Get-Content "test/e2e/setup.expect" -Encoding UTF8 | wsl -d "${{ env.instance }}" -u root -- bash -c "cat > /tmp/setup.expect"

          # Run the expect script
          wsl -d "${{ env.instance }}" -u root -- expect /tmp/setup.expect "${{ matrix.username }}" "${{ matrix.password }}" "${{ matrix.consent }}"

      - name: Verify User Creation
        shell: powershell
        run: |
          # Verify user exists
          wsl -d "${{ env.instance }}" -u root -- id "${{ matrix.username }}"

          # Verify default user
          $defaultUser = wsl -d "${{ env.instance }}" -- whoami
          if ($defaultUser.Trim() -ne "${{ matrix.username }}") {
              Write-Output "::error::Default user mismatch. Expected: ${{ matrix.username }}, Got: $defaultUser"
              exit 1
          }

          $uid = wsl -d "${{ env.instance }}" -- id -u
          if ($uid.Trim() -eq "0") {
              Write-Output "::error::Default user is root."
              exit 1
          }

      - name: Verify Insights Cache
        shell: powershell
        run: |
          $localPath = "~/.cache/ubuntu-insights/wsl_setup/local"
          $uploadedPath = "~/.cache/ubuntu-insights/wsl_setup/uploaded"

          $cmd = "if ([ -d $localPath ] && ls -A $localPath 2>/dev/null | grep -q .) || ([ -d $uploadedPath ] && ls -A $uploadedPath 2>/dev/null | grep -q .); then echo 'yes'; else echo 'no'; fi"

          $hasFiles = wsl -d "${{ env.instance }}" -- bash -c "$cmd"

          if ($hasFiles.Trim() -eq "no") {
              Write-Output "::error::Expected insights cache files in local or uploaded directory not found."
              exit 1
          }

      - name: Verify Consent
        shell: powershell
        run: |
          # Verify consent state (if not skipped)
          if ("${{ matrix.consent }}" -eq "yes") {
              $out = wsl -d "${{ env.instance }}" -u "${{ matrix.username }}" -- ubuntu-insights consent
              if ($out -notmatch "Default: true") {
                  Write-Output "::error::Expected consent to be true, got: $out"
                  exit 1
              }
          } elseif ("${{ matrix.consent }}" -eq "no") {
              $out = wsl -d "${{ env.instance }}" -u "${{ matrix.username }}" -- ubuntu-insights consent
              if ($out -notmatch "Default: false") {
                  Write-Output "::error::Expected consent to be false, got: $out"
                  exit 1
              }
          }

      - name: Verify Registry
        shell: powershell
        run: |
          # Verify Registry Key
          $regPath = "${{ env.REGISTRY_PATH }}"
          $regName = "${{ env.REGISTRY_KEY }}"
          $regExists = $false
          $regValue = $null

          if (Test-Path $regPath) {
              $prop = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue
              if ($prop) {
                  $regExists = $true
                  $regValue = $prop.$regName
              }
          }

          Write-Output "Registry Key Exists: $regExists"
          if ($regExists) {
              Write-Output "Registry Key Value: $regValue"
          }

          if ("${{ matrix.registry-flag }}" -ne "skip") {
              # Case: Registry key was present initially.
              # Expectation: It should still exist and match the initial value.
              if (-not $regExists) {
                  Write-Output "::error::Registry key missing. It was pre-set and should persist."
                  exit 1
              }
              if ($regValue -ne [int]"${{ matrix.registry-flag }}") {
                  Write-Output "::error::Registry value mismatch. Expected ${{ matrix.registry-flag }}, got $regValue"
                  exit 1
              }
          } elseif ("${{ matrix.config-state }}" -ne "skip") {
              # Case: Local config was present initially, and Registry was NOT pre-set.
              # Expectation: Registry key should NOT be created/touched.
              if ($regExists) {
                  Write-Output "::error::Registry key should not exist when local config is present."
                  exit 1
              }
            } elseif (("${{ matrix.consent }}" -eq "yes") -or ("${{ matrix.consent }}" -eq "default")) {
              # Case: Interactive Yes.
              # Expectation: Registry key created and set to 1.
              if (-not $regExists) {
                  Write-Output "::error::Registry key missing after interactive Yes."
                  exit 1
              }
              if ($regValue -ne 1) {
                  Write-Output "::error::Registry value mismatch. Expected 1, got $regValue"
                  exit 1
              }
          } elseif ("${{ matrix.consent }}" -eq "no") {
              # Case: Interactive No.
              # Expectation: Registry key created and set to 0.
              if (-not $regExists) {
                  Write-Output "::error::Registry key missing after interactive No."
                  exit 1
              }
              if ($regValue -ne 0) {
                  Write-Output "::error::Registry value mismatch. Expected 0, got $regValue"
                  exit 1
              }
          }

      - name: Clean up
        if: always()
        shell: powershell
        run: |
          wsl --unregister ${{ env.instance }}
